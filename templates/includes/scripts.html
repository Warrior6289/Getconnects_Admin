<!-- Shared scripts required by most pages. Include this partial at the end
     of your template to load core JavaScript dependencies. -->
<script src="{{ url_for('static', filename='assets/js/vendor-all.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/plugins/bootstrap/js/bootstrap.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/pcoded.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/dark-mode.js') }}"></script>
<script src="{{ url_for('static', filename='assets/js/confirm.js') }}"></script>
<script>
// Auto-scroll sidebar when menu items expand
(function() {
  function scrollToExpandedMenu() {
    const sidebar = document.querySelector('.pcoded-navbar .scroll-div.navbar-content');
    if (!sidebar) return;
    
    const expandedMenu = document.querySelector('.pcoded-navbar .pcoded-hasmenu.pcoded-trigger');
    if (!expandedMenu) return;
    
    const submenu = expandedMenu.querySelector('.pcoded-submenu');
    if (!submenu) return;
    
    // Get positions relative to sidebar
    const sidebarRect = sidebar.getBoundingClientRect();
    const menuRect = expandedMenu.getBoundingClientRect();
    const submenuRect = submenu.getBoundingClientRect();
    
    // Calculate if submenu is visible
    const sidebarTop = sidebarRect.top;
    const sidebarBottom = sidebarRect.bottom;
    const submenuTop = submenuRect.top;
    const submenuBottom = submenuRect.bottom;
    
    // If submenu extends beyond bottom of sidebar, scroll down
    if (submenuBottom > sidebarBottom) {
      const scrollAmount = submenuBottom - sidebarBottom + 30; // 30px padding
      sidebar.scrollTop += scrollAmount;
    }
    // If menu item is above visible area, scroll up to show it
    else if (menuRect.top < sidebarTop) {
      const scrollAmount = sidebarTop - menuRect.top + 30;
      sidebar.scrollTop -= scrollAmount;
    }
  }
  
  // Listen for menu clicks
  document.addEventListener('DOMContentLoaded', function() {
    const menuItems = document.querySelectorAll('.pcoded-navbar .pcoded-hasmenu > a');
    
    menuItems.forEach(function(menuItem) {
      menuItem.addEventListener('click', function() {
        // Wait for menu expansion animation to complete
        setTimeout(scrollToExpandedMenu, 350);
      });
    });
    
    // Also use MutationObserver to catch programmatic menu expansions
    const sidebar = document.querySelector('.pcoded-navbar .scroll-div.navbar-content');
    if (sidebar) {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const target = mutation.target;
            if (target.classList.contains('pcoded-trigger')) {
              setTimeout(scrollToExpandedMenu, 350);
            }
          }
        });
      });
      
      const navBar = document.querySelector('.pcoded-navbar .pcoded-inner-navbar');
      if (navBar) {
        observer.observe(navBar, {
          attributes: true,
          subtree: true,
          attributeFilter: ['class']
        });
      }
    }
  });
})();
</script>
<script>
// Search functionality
(function() {
  let searchTimeout;
  let searchResultsContainer = null;
  
  function createSearchResultsContainer() {
    if (searchResultsContainer) return searchResultsContainer;
    
    const container = document.createElement('div');
    container.id = 'search-results';
    container.style.display = 'none';
    
    const searchBox = document.querySelector('.main-search');
    if (searchBox) {
      searchBox.appendChild(container);
      searchResultsContainer = container;
    }
    
    return container;
  }
  
  function renderSearchResults(results) {
    const container = createSearchResultsContainer();
    
    if (!results || results.length === 0) {
      container.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">No results found</div>';
      container.style.display = 'block';
      return;
    }
    
    let html = '';
    results.forEach(function(result) {
      const typeIcon = {
        'client': 'icon-users',
        'campaign': 'icon-bar-chart-2',
        'lead': 'icon-user'
      }[result.type] || 'icon-file';
      
      html += `
        <a href="${result.url}" style="display: block; padding: 12px 20px; border-bottom: 1px solid #f1f1f1; text-decoration: none; color: #333; transition: background 0.2s;" 
           onmouseover="this.style.background='#f8f9fa'" 
           onmouseout="this.style.background='#fff'">
          <div style="display: flex; align-items: center;">
            <i class="feather ${typeIcon}" style="margin-right: 12px; color: #04a9f5; font-size: 18px;"></i>
            <div style="flex: 1;">
              <div style="font-weight: 500; margin-bottom: 4px;">${result.title}</div>
              <div style="font-size: 12px; color: #666;">${result.subtitle}</div>
            </div>
            <span style="font-size: 11px; color: #999; text-transform: capitalize; padding: 4px 8px; background: #f1f1f1; border-radius: 3px;">${result.type}</span>
          </div>
        </a>
      `;
    });
    
    container.innerHTML = html;
    container.style.display = 'block';
  }
  
  function performSearch(query) {
    if (!query || query.length < 2) {
      if (searchResultsContainer) {
        searchResultsContainer.style.display = 'none';
      }
      return;
    }
    
    fetch(`/api/search?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        renderSearchResults(data.results);
      })
      .catch(error => {
        console.error('Search error:', error);
        if (searchResultsContainer) {
          searchResultsContainer.style.display = 'none';
        }
      });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('m-search');
    const searchBtn = document.querySelector('.search-btn');
    const searchClose = document.querySelector('.search-close');
    const mainSearch = document.querySelector('.main-search');
    
    if (!searchInput || !mainSearch) return;
    
    // Toggle search box open/close
    function openSearch() {
      mainSearch.classList.add('open');
      searchInput.focus();
      createSearchResultsContainer();
    }
    
    function closeSearch() {
      mainSearch.classList.remove('open');
      searchInput.value = '';
      if (searchResultsContainer) {
        searchResultsContainer.style.display = 'none';
      }
    }
    
    // Open search on button click
    if (searchBtn) {
      searchBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (mainSearch.classList.contains('open')) {
          performSearch(searchInput.value);
        } else {
          openSearch();
        }
      });
    }
    
    // Close search on X click
    if (searchClose) {
      searchClose.addEventListener('click', function(e) {
        e.preventDefault();
        closeSearch();
      });
    }
    
    // Handle search input
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(function() {
          performSearch(query);
        }, 300);
      } else {
        if (searchResultsContainer) {
          searchResultsContainer.style.display = 'none';
        }
      }
    });
    
    // Handle Enter key
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const query = this.value.trim();
        if (query.length >= 2) {
          performSearch(query);
        }
      } else if (e.key === 'Escape') {
        closeSearch();
      }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (mainSearch && !mainSearch.contains(e.target)) {
        if (searchResultsContainer) {
          searchResultsContainer.style.display = 'none';
        }
      }
    });
  });
})();
</script>
