{# Clients management page. Displays existing clients and actions
   to add, edit or delete entries. #}
{% extends 'base.html' %}
{% block title %}Clients - GetConnects Portal{% endblock %}

{% block stylesheets %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
  <style>
    /* Align length selector and search input on one row */
    #clientsTable_wrapper .row:first-child {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .5rem;
    }
    #clientsTable_wrapper .row:first-child > div {
      flex: 0 0 auto;
      width: auto;
    }

    /* Search bar spacing */
    #clientsTable_filter {
      margin-left: auto;
      margin-top: 10px;
    }

    /* Rounded search bar */
    #clientsTable_filter input {
      border-radius: 50rem;
    }

    /* Sticky bold table header */
    #clientsTable thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
      font-weight: 600;
    }

    /* Highlight rows on hover */
    #clientsTable tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    /* Rounded pagination buttons */
    #clientsTable_wrapper .pagination .page-link {
      border-radius: 50rem;
      margin: 0 2px;
    }
  </style>
{% endblock %}

{% block content %}
<h1 class="mb-3">Clients</h1>
<div class="text-end mb-3">
  <button class="btn btn-primary" data-toggle="modal" data-target="#addClientModal">+ Add Client</button>
</div>
<div class="card">
  <div class="table-responsive">
    <table id="clientsTable" class="table table-striped table-hover mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Company</th>
          <th>Contact</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Created At</th>
          <th>Manage</th>
        </tr>
      </thead>
      <tbody id="clientRows">
        {% for client in clients %}
        <tr>
          <td>{{ client.id }}</td>
          <td>{{ client.company_name }}</td>
          <td>{{ client.contact_name }}</td>
          <td>{{ client.contact_email }}</td>
          <td>{{ client.phone }}</td>
          <td>{{ client.created_at }}</td>
          <td>
            <a class="btn btn-sm btn-primary" href="/clients/{{ client.id }}/manage">Manage</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id="loading" class="text-center p-4 d-none">Loading...</div>
  </div>
</div>

<div class="modal fade" id="addClientModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {{ form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title">Add New Client</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ form.company_name.label(class="form-label") }}
            {{ form.company_name(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.contact_name.label(class="form-label") }}
            {{ form.contact_name(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.contact_email.label(class="form-label") }}
            {{ form.contact_email(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.phone.label(class="form-label") }}
            {{ form.phone(class="form-control") }}
          </div>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
  <button type="submit" class="btn btn-primary">Save</button>
</div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
  {{ super() }}
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script>
    async function loadClients() {
      const loader = document.getElementById('loading');
      loader.classList.remove('d-none');
      const res = await fetch('/api/clients');
      const data = await res.json();
      const tbody = document.getElementById('clientRows');
      tbody.innerHTML = '';
      data.forEach(c => {
        const row = `<tr>
          <td>${c.id}</td>
          <td>${c.company_name}</td>
          <td>${c.contact_name}</td>
          <td>${c.contact_email}</td>
          <td>${c.phone}</td>
          <td>${c.created_at || ''}</td>
          <td><a class='btn btn-sm btn-primary' href='/clients/${c.id}/manage'>Manage</a></td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No clients</td></tr>';
      }
      loader.classList.add('d-none');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadClients();
      $('#clientsTable').DataTable();
      // customize search input
      const searchInput = document.querySelector('#clientsTable_filter input');
      if (searchInput) {
        searchInput.placeholder = 'Search clientsâ€¦';
        searchInput.classList.add('form-control', 'form-control-sm', 'rounded-pill');
      }
      const lengthSelect = document.querySelector('#clientsTable_length select');
      if (lengthSelect) {
        lengthSelect.classList.add('form-select', 'form-select-sm');
      }
    });
  </script>
{% endblock %}
