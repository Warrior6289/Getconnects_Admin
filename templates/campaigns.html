{% extends 'base.html' %}
{% block title %}Campaigns - GetConnects Portal{% endblock %}

{% block stylesheets %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
  <style>
    /* Align length selector and search input on one row */
    #campaignsTable_wrapper .row:first-child {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .5rem;
    }
    #campaignsTable_wrapper .row:first-child > div {
      flex: 0 0 auto;
      width: auto;
    }

    /* Search bar spacing */
    #campaignsTable_filter {
      margin-left: auto;
      margin-top: 10px;
    }

    /* Rounded search bar */
    #campaignsTable_filter input {
      border-radius: 50rem;
    }
  </style>
{% endblock %}

{% block content %}
<h1 class="mb-3">Campaigns</h1>
<form method="post" action="/campaigns/sync" class="mb-3">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <button class="btn btn-primary">Sync Campaigns</button>
</form>
<div class="card">
  <div class="table-responsive">
    <table id="campaignsTable" class="table table-striped table-hover mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Status</th>
          <th>Client</th>
          <th>Lead Type Groups</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="campaignRows"></tbody>
    </table>
    <div id="loading" class="text-center p-4 d-none">Loading...</div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
  {{ super() }}
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
  <script>
  async function loadCampaigns() {
    const loader = document.getElementById('loading');
    const tbody = document.getElementById('campaignRows');
    
    // Clear any existing rows first
    tbody.innerHTML = '';
    loader.classList.remove('d-none');
    
    try {
      const res = await fetch('/api/campaigns');
      if (!res.ok) {
        throw new Error('Failed to load campaigns');
      }
      const data = await res.json();
      
      // Ensure we always create exactly 6 columns to match the header
      data.forEach(c => {
        const row = document.createElement('tr');
        
        // Create cells with proper text content to avoid XSS
        const cells = [
          document.createElement('td'),
          document.createElement('td'),
          document.createElement('td'),
          document.createElement('td'),
          document.createElement('td'),
          document.createElement('td')
        ];
        
        cells[0].textContent = c.id || '';
        cells[1].textContent = c.campaign_name || '';
        cells[2].textContent = c.status || '';
        cells[3].textContent = c.client_name || '';
        
        // Lead type groups
        const groups = c.lead_type_groups && c.lead_type_groups.length > 0
          ? c.lead_type_groups.join(', ')
          : 'not yet assigned';
        cells[4].textContent = groups;
        
        // Manage button with proper HTML
        const manageLink = document.createElement('a');
        manageLink.className = 'btn btn-sm btn-secondary';
        manageLink.href = `/campaigns/${c.id || ''}`;
        manageLink.textContent = 'Manage';
        cells[5].appendChild(manageLink);
        
        cells.forEach(cell => row.appendChild(cell));
        tbody.appendChild(row);
      });
      
      if (data.length === 0) {
        // When there are no campaigns, still render a row with 6 empty cells
        // so the column count matches the header.
        const row = document.createElement('tr');
        for (let i = 0; i < 6; i += 1) {
          const cell = document.createElement('td');
          if (i === 0) {
            cell.textContent = 'No campaigns found';
          } else {
            cell.textContent = '';
          }
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      }
    } catch (error) {
      console.error('Error loading campaigns:', error);
      // On error, also keep a 6-column row so DataTables column count matches.
      const row = document.createElement('tr');
      for (let i = 0; i < 6; i += 1) {
        const cell = document.createElement('td');
        if (i === 0) {
          cell.textContent = 'Error loading campaigns. Please refresh the page.';
          cell.className = 'text-danger';
        } else {
          cell.textContent = '';
        }
        row.appendChild(cell);
      }
      tbody.appendChild(row);
    } finally {
      loader.classList.add('d-none');
    }
  }

  let dataTableInstance = null;

  document.addEventListener('DOMContentLoaded', async () => {
    // Clear any server-side rendered rows immediately
    const tbody = document.getElementById('campaignRows');
    tbody.innerHTML = '';
    
    // Load campaigns data first
    await loadCampaigns();
    
    // Initialize DataTables only after data is loaded
    // Destroy existing instance if any (for page refreshes)
    if (dataTableInstance) {
      dataTableInstance.destroy();
    }
    
    dataTableInstance = $('#campaignsTable').DataTable({
      order: [[0, 'desc']], // Sort by ID descending
      pageLength: 10,
      responsive: true
    });

    // customize search input
    const searchInput = document.querySelector('#campaignsTable_filter input');
    if (searchInput) {
      searchInput.placeholder = 'Search campaignsâ€¦';
      searchInput.classList.add('form-control', 'form-control-sm', 'rounded-pill');
    }
    const lengthSelect = document.querySelector('#campaignsTable_length select');
    if (lengthSelect) {
      lengthSelect.classList.add('form-select', 'form-select-sm');
    }
  });
  </script>
{% endblock %}
