{% extends 'base.html' %}
{% block title %}JustCall Webhook - {{ webhook.token }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col-sm-12">
    <div class="card">
      <div class="card-header">
        <h5>Webhook Token: {{ webhook.token }}</h5>
      </div>
      <div class="card-block">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <p>Click the button below to fetch the most recent payload received for this webhook.</p>
        <button id="retest-webhook" class="btn btn-primary" data-token="{{ webhook.token }}">Re-Test</button>
        <div id="payload-status" class="mt-2" style="display:none;"></div>
        <pre id="payload" class="mt-3 bg-light p-3"><code>{}</code></pre>
        <h6 class="mt-4">Sample curl</h6>
        <p>Send a test payload using the command below, then click "Test Webhook" again to view the latest payload.</p>
        <pre><code>curl -X POST -H "Content-Type: application/json" -d '{"sample":"payload"}' {{ url_for('webhooks.justcall_webhook', token=webhook.token, _external=True) }}</code></pre>
        <form method="post" action="{{ url_for('settings.justcall_settings') }}" class="mt-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="delete_webhook" value="{{ webhook.id }}" />
          <button class="btn btn-danger">Delete Webhook</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-sm-12">
    <div class="card">
      <div class="card-header">
        <h5>Field Mapping</h5>
      </div>
      <div class="card-block">
        {% if webhook.target_type == 'lead' %}
          {% set fields = ['name','phone','email','address','company','secondary_phone','campaign_id','lead_type','caller_name','caller_number','notes'] %}
        {% elif webhook.target_type == 'campaign' %}
          {% set fields = ['id','campaign_name','status','client_id'] %}
        {% else %}
          {% set fields = [] %}
        {% endif %}
        <form id="mapping-form" data-token="{{ webhook.token }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <table class="table">
            <thead>
              <tr><th>Field</th><th>JSON Path</th></tr>
            </thead>
            <tbody>
              {% for field in fields %}
              <tr>
                <td>{{ field.replace('_', ' ')|title }}</td>
                <td>
                  <select class="form-control mapping-select" data-field="{{ field }}">
                    <option value="">Select field...</option>
                  </select>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <button type="submit" class="btn btn-primary">Save Mapping</button>
          <div id="mapping-status" class="mt-2" style="display:none;"></div>
        </form>
      </div>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='assets/js/justcall_webhook.js') }}"></script>
{% endblock %}
